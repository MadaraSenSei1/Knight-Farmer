<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Travian Bot</title>
  <script src="https://www.paypal.com/sdk/js?client-id=AccZS6kT4eWWJklsYhrFFhVPhc5ecbmSZext6BFu0GTtwJETs8kyU6TA_0IUlyazAfHwWvwiaQI2wQto&currency=EUR"></script>
</head>
<body>
  <h1>Travian Farming Bot</h1>

  <form id="loginForm">
    <input type="text" name="username" placeholder="Travian Username" required />
    <input type="password" name="password" placeholder="Travian Password" required />
    <input type="text" name="server_url" placeholder="https://ts1.travian.de" required />
    <h4>Optional Proxy:</h4>
    <input type="text" name="proxy_ip" placeholder="Proxy IP">
    <input type="text" name="proxy_port" placeholder="Proxy Port">
    <input type="text" name="proxy_user" placeholder="Proxy Username">
    <input type="password" name="proxy_pass" placeholder="Proxy Password">
    <button type="submit">Login</button>
  </form>

  <div id="paypal-button-container" style="display:none;"></div>
  <div id="farmLists" style="margin-top:20px;"></div>

  <div id="botControl" style="display:none;">
    <h3>Bot Control</h3>
    <input type="number" id="min_interval" placeholder="Min (min)" />
    <input type="number" id="max_interval" placeholder="Max (min)" />
    <label><input type="checkbox" id="random_offset"> ±30s zufällig</label>
    <button onclick="startBot()">Start Bot</button>
    <button onclick="stopBot()">Stop Bot</button>
    <p id="statusText"></p>
  </div>

  <script>
    let uid = null;
    let paid = false;

    document.getElementById('loginForm').onsubmit = async function (e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const res = await fetch('/login', { method: 'POST', body: formData });
      const data = await res.json();

      if (data.uid) {
        uid = data.uid;
        document.getElementById('farmLists').innerHTML = `<pre>${JSON.stringify(data.farm_lists, null, 2)}</pre>`;
        document.getElementById('paypal-button-container').style.display = 'block';

        paypal.Buttons({
          createOrder: function(data, actions) {
            return actions.order.create({
              purchase_units: [{ amount: { value: '5.00' } }]
            });
          },
          onApprove: function(data, actions) {
            return actions.order.capture().then(function(details) {
              paid = true;
              document.getElementById('botControl').style.display = 'block';
              alert('Bezahlung erfolgreich. Bot kann jetzt gestartet werden.');
            });
          }
        }).render('#paypal-button-container');
      } else {
        alert(data.error || 'Login fehlgeschlagen');
      }
    };

    async function startBot() {
      if (!paid) return alert('Bitte zuerst bezahlen');
      const min = document.getElementById('min_interval').value;
      const max = document.getElementById('max_interval').value;
      const random = document.getElementById('random_offset').checked;
      const formData = new FormData();
      formData.append('uid', uid);
      formData.append('min_interval', min);
      formData.append('max_interval', max);
      formData.append('random_offset', random);
      const res = await fetch('/start', { method: 'POST', body: formData });
      const data = await res.json();
      document.getElementById('statusText').innerText = data.status || data.error;
    }

    async function stopBot() {
      const formData = new FormData();
      formData.append('uid', uid);
      const res = await fetch('/stop', { method: 'POST', body: formData });
      const data = await res.json();
      document.getElementById('statusText').innerText = data.status || data.error;
    }
  </script>
</body>
</html>
