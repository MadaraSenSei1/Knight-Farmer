<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Knight Farmer Bot</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.paypal.com/sdk/js?client-id=AccZS6kT4eWWJklsYhrFFhVPhc5ecbmSZext6BFu0GTtwJETs8kyU6TA_0IUlyazAfHwWvwiaQI2wQto&currency=EUR"></script>
</head>
<body class="bg-gray-900 text-white p-6">
  <div class="max-w-2xl mx-auto">
    <h1 class="text-3xl font-bold mb-4">Knight Farmer Bot</h1>

    <!-- Login -->
    <form id="loginForm" class="space-y-3">
      <input type="text" name="username" placeholder="Travian Username" class="w-full p-2 rounded bg-gray-800" required />
      <input type="password" name="password" placeholder="Travian Password" class="w-full p-2 rounded bg-gray-800" required />
      <input type="text" name="server_url" placeholder="Server URL (e.g. https://ts1.travian.com)" class="w-full p-2 rounded bg-gray-800" required />

      <!-- Optional Proxy -->
      <input type="text" name="proxy_ip" placeholder="Proxy IP (optional)" class="w-full p-2 rounded bg-gray-800" />
      <input type="text" name="proxy_port" placeholder="Proxy Port" class="w-full p-2 rounded bg-gray-800" />
      <input type="text" name="proxy_user" placeholder="Proxy Username" class="w-full p-2 rounded bg-gray-800" />
      <input type="password" name="proxy_pass" placeholder="Proxy Password" class="w-full p-2 rounded bg-gray-800" />
      
      <button type="submit" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">Login</button>
    </form>

    <!-- Farm List + Bot -->
    <div id="botPanel" class="mt-6 hidden">
      <h2 class="text-xl font-semibold mb-2">Farm Lists</h2>
      <ul id="farmLists" class="bg-gray-800 p-3 rounded"></ul>

      <!-- Intervall + Timer -->
      <div class="mt-4 space-y-2">
        <input id="minInterval" type="number" placeholder="Min Interval (minutes)" class="w-full p-2 rounded bg-gray-800" />
        <input id="maxInterval" type="number" placeholder="Max Interval (minutes)" class="w-full p-2 rounded bg-gray-800" />
        <label class="inline-flex items-center">
          <input type="checkbox" id="randomOffset" class="mr-2" checked />
          Â±30s Random Offset
        </label>
      </div>

      <!-- PayPal Button -->
      <div id="paypal-button-container" class="my-4"></div>

      <!-- Bot Controls -->
      <div class="flex space-x-2 mt-4">
        <button id="startBot" class="bg-green-600 px-4 py-2 rounded hover:bg-green-700">Start Bot</button>
        <button id="stopBot" class="bg-red-600 px-4 py-2 rounded hover:bg-red-700">Stop Bot</button>
      </div>

      <p id="countdown" class="mt-4 text-yellow-400"></p>
    </div>
  </div>

  <script>
    let uid = null;
    let paid = false;

    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const res = await fetch("/login", {
        method: "POST",
        body: formData,
      });

      const data = await res.json();
      if (data.uid) {
        uid = data.uid;
        const list = document.getElementById("farmLists");
        list.innerHTML = "";
        data.farm_lists.forEach(name => {
          const li = document.createElement("li");
          li.textContent = name;
          list.appendChild(li);
        });
        document.getElementById("botPanel").classList.remove("hidden");
      } else {
        alert("Login failed: " + (data.error || "Unknown error"));
      }
    });

    paypal.Buttons({
      createOrder: function(data, actions) {
        return actions.order.create({
          purchase_units: [{ amount: { value: '5.00' } }]
        });
      },
      onApprove: function(data, actions) {
        return actions.order.capture().then(function(details) {
          paid = true;
          alert("Payment successful! You can now start the bot.");
        });
      }
    }).render('#paypal-button-container');

    document.getElementById("startBot").onclick = async () => {
      if (!paid) return alert("Please complete payment first.");

      const min = document.getElementById("minInterval").value;
      const max = document.getElementById("maxInterval").value;
      const rand = document.getElementById("randomOffset").checked;

      const formData = new FormData();
      formData.append("uid", uid);
      formData.append("min_interval", min);
      formData.append("max_interval", max);
      formData.append("random_offset", rand);

      const res = await fetch("/start", { method: "POST", body: formData });
      const data = await res.json();

      if (data.status === "started") {
        alert("Bot started!");
        pollCountdown();
      } else {
        alert("Start failed: " + data.error);
      }
    };

    document.getElementById("stopBot").onclick = async () => {
      const formData = new FormData();
      formData.append("uid", uid);
      const res = await fetch("/stop", { method: "POST", body: formData });
      const data = await res.json();
      if (data.status === "stopped") {
        alert("Bot stopped.");
        document.getElementById("countdown").textContent = "";
      }
    };

    function pollCountdown() {
      const el = document.getElementById("countdown");
      setInterval(async () => {
        const res = await fetch("/status?uid=" + uid);
        const data = await res.json();
        if (data.next_raid) {
          const now = Math.floor(Date.now() / 1000);
          const diff = data.next_raid - now;
          if (diff > 0) {
            const min = Math.floor(diff / 60);
            const sec = diff % 60;
            el.textContent = `Next raid in ${min}m ${sec}s`;
          } else {
            el.textContent = "Raid is executing...";
          }
        }
      }, 1000);
    }
  </script>
</body>
</html>
<script>
